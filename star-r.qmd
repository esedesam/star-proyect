---
title: "Proyecto STAR"
subtitle: "Inferencia Causal"
description: "Máster en Ciencia de Datos (UV)"
author: "Adrián Lara, Jesús Martínez, Miguel Muñoz, Samuel Ortega & Pablo Vicente"
date: last-modified
date-format: "DD-MM-YYYY"
title-block-banner: "#B0C8D6"
format: 
  html:
    embed-resources: true
    smooth-scroll: true
    toc: true
    toc_float: yes
    theme: cosmo
    fontcolor: black
editor: source
execute: 
  echo: false
  warning: false
  error: false
  message: false
  include: true
lang: es
css: utilities/qmdStyle.css
---

# Proyecto *STAR*

```{r setup}
#| include: false

# Cargar pacman
if (!require("pacman", quietly = TRUE)) {
  install.packages("pacman")
  library(pacman)
}

# Cargar los paquetes necesarios
p_load(AER, ggplot2, ggthemes, dplyr, tidyr, knitr)

# Ajustes adicionales
theme_set(
  theme_minimal() +
    theme(
      panel.border = element_rect(color = "black", fill = NA),
      axis.ticks = element_line(color = "black")))

defaultFillColor <- "steelblue"
update_geom_defaults("bar", aes(fill = defaultFillColor))
update_geom_defaults("boxplot", aes(fill = defaultFillColor))

# Definición de funciones
plotCombinedFeature <- function(starDf, featureId, featureLabel = NA, isNumeric = TRUE, removeNa = FALSE) {
  if (is.na(featureLabel)) {
    featureLabel <- featureId
  }
  plotDf <- pivot_longer(
    starDf,
    cols = grep(paste0("^", featureId, ".{1}$"), colnames(starDf), value = TRUE),
    names_to = "grade",
    values_to = "value")
  
  featureLevels <- paste0(featureId, c("k", "1", "2", "3"))
  plotDf$grade <- factor(
    plotDf$grade,
    levels = featureLevels,
    labels = c("Kindergarden", "Primero", "Segundo", "Tercero"),
    ordered = TRUE)
  
  if (removeNa) {
    plotDf <- na.omit(plotDf[, c("grade", "value")])
  }
  
  if (isNumeric) {
    ggplot(plotDf, aes(x = grade, y = value)) +
      geom_boxplot() +
      labs(x = "Curso", y = featureLabel)
  } else {
    ggplot(plotDf, aes(x = value, fill = grade)) +
      geom_bar(position = "dodge") +
      labs(x = featureLabel, y = "Frecuencia acumulada", fill = "Curso")
  }
}

# Numerización automática en tablas y figuras

outputFormat   = opts_knit$get("rmarkdown.pandoc.to")

capTabNo = 2; capFigNo = 1;

capTab = function(x){
  if(outputFormat == 'html'){
    x = paste0("<strong>Table ", capTabNo,". </strong> ",x)
    capTabNo <<- capTabNo + 1
  }; x
}

capFig = function(x, y){
  if(outputFormat == 'html'){
    x = paste0("<strong>Figura ", capFigNo, ".</strong> ", x, " \\label{fig:", y, "}")
    capFigNo <<- capFigNo + 1
  }; x
}
```

## Introducción

El proyecto *STAR* (*Student-Teacher Achievement Ratio*) es un estudio sobre el tamaño de las clases llevado a cabo en Tennessee en tres fases, diseñado para determinar el efecto del **tamaño reducido de las clases** en los primeros grados sobre el **rendimiento académico** a corto y largo plazo de los alumnos. Se inspiró en un estudio prometedor realizado en Indiana sobre los beneficios de las clases pequeñas, pero también consideró los costos adicionales de más aulas y profesores. La legislatura de Tennessee autorizó este estudio de **cuatro años** para obtener datos sobre la eficacia de las clases reducidas.

Se compararon los resultados de alumnos en **jardines de infancia** y en los **primeros tres grados**, en clases pequeñas de **13 a 17 alumnos**, clases regulares de **22 a 25 alumnos** y clases regulares con un **profesor particular**. Aproximadamente 6500 alumnos en 330 aulas de unas 80 escuelas fueron evaluados en **lectura**, **matemáticas** y habilidades básicas de estudio mediante [pruebas estandarizadas](https://en.wikipedia.org/wiki/Stanford_Achievement_Test_Series). Después de los cuatro años, se comprobó que las clases pequeñas mejoraron significativamente el aprendizaje temprano y los estudios cognitivos.

```{r, groupsSTAR}
groupsTable <- data.frame(
  Grado = c("K", "1", "2", "3"),
  `Tratamiento 1` = c("Clase pequeña", "Clase pequeña", "Clase pequeña", "Clase pequeña"),
  `Tratamiento 2` = c("Clase regular + asistente", "Clase regular + asistente", "Clase regular + asistente", "Clase regular + asistente"),
  Control = c("Clase regular", "Clase regular", "Clase regular", "Clase regular")
)
kable(groupsTable, caption = "<strong>Tabla 1. </strong> Grupos de control y tratamiento en el experimento STAR")
```

Los datos del estudio están disponibles en el paquete `AER` de `R`.

## Descripción del problema

En primer lugar, cargamos los datos a nuestro espacio de trabajo.

```{r cargar-datos}
#| echo: true
data(STAR)
starDf <- STAR
```

Encontramos con las siguientes características:

1. **gender**: Factor que indica el género del estudiante.

2. **ethnicity**: Factor que indica la etnicidad del estudiante con niveles "cauc" (Caucásico), "afam" (Afroamericano), "asian" (Asiático), "hispanic" (Hispano), "amindian" (Indio Americano) o "other" (Otro).

3. **birth**: Trimestre de nacimiento del estudiante (del año de clase).

4. **stark**: Factor que indica el tipo de clase STAR en jardín de infancia: regular, pequeña o regular-con-ayudante. NA indica que no asistió a ninguna clase STAR.

5. **star1**: Factor que indica el tipo de clase STAR en primer grado: regular, pequeña o regular-con-ayudante. NA indica que no asistió a ninguna clase STAR.

6. **star2**: Factor que indica el tipo de clase STAR en segundo grado: regular, pequeña o regular-con-ayudante. NA indica que no asistió a ninguna clase STAR.

7. **star3**: Factor que indica el tipo de clase STAR en tercer grado: regular, pequeña o regular-con-ayudante. NA indica que no asistió a ninguna clase STAR.

8. **readk**: Puntuación total de lectura en jardín de infancia.

9. **read1**: Puntuación total de lectura en primer grado.

10. **read2**: Puntuación total de lectura en segundo grado.

11. **read3**: Puntuación total de lectura en tercer grado.

12. **mathk**: Puntuación total de matemáticas en jardín de infancia.

13. **math1**: Puntuación total de matemáticas en primer grado.

14. **math2**: Puntuación total de matemáticas en segundo grado.

15. **math3**: Puntuación total de matemáticas en tercer grado.

16. **lunchk**: Factor que indica si el estudiante calificó para almuerzo gratuito en jardín de infancia.

17. **lunch1**: Factor que indica si el estudiante calificó para almuerzo gratuito en primer grado.

18. **lunch2**: Factor que indica si el estudiante calificó para almuerzo gratuito en segundo grado.

19. **lunch3**: Factor que indica si el estudiante calificó para almuerzo gratuito en tercer grado.

20. **schoolk**: Factor que indica el tipo de escuela en jardín de infancia: "inner-city" (ciudad interior), "suburban" (suburbana), "rural" (rural) o "urban" (urbana).

21. **school1**: Factor que indica el tipo de escuela en primer grado: "inner-city" (ciudad interior), "suburban" (suburbana), "rural" (rural) o "urban" (urbana).

22. **school2**: Factor que indica el tipo de escuela en segundo grado: "inner-city" (ciudad interior), "suburban" (suburbana), "rural" (rural) o "urban" (urbana).

23. **school3**: Factor que indica el tipo de escuela en tercer grado: "inner-city" (ciudad interior), "suburban" (suburbana), "rural" (rural) o "urban" (urbana).

24. **degreek**: Factor que indica el título más alto del maestro en jardín de infancia: "bachelor" (licenciatura), "master" (maestría), "specialist" (especialista) o "master+" (maestría+).

25. **degree1**: Factor que indica el título más alto del maestro en primer grado: "bachelor" (licenciatura), "master" (maestría), "specialist" (especialista) o "phd" (doctorado).

26. **degree2**: Factor que indica el título más alto del maestro en segundo grado: "bachelor" (licenciatura), "master" (maestría), "specialist" (especialista) o "phd" (doctorado).

27. **degree3**: Factor que indica el título más alto del maestro en tercer grado: "bachelor" (licenciatura), "master" (maestría), "specialist" (especialista) o "phd" (doctorado).

28. **ladderk**: Factor que indica el nivel de carrera del maestro en jardín de infancia: "level1" (nivel 1), "level2" (nivel 2), "level3" (nivel 3), "apprentice" (aprendiz), "probation" (en prueba) o "pending" (pendiente).

29. **ladder1**: Factor que indica el nivel de carrera del maestro en primer grado: "level1" (nivel 1), "level2" (nivel 2), "level3" (nivel 3), "apprentice" (aprendiz), "probation" (en prueba) o "noladder" (sin nivel).

30. **ladder2**: Factor que indica el nivel de carrera del maestro en segundo grado: "level1" (nivel 1), "level2" (nivel 2), "level3" (nivel 3), "apprentice" (aprendiz), "probation" (en prueba) o "noladder" (sin nivel).

31. **ladder3**: Factor que indica el nivel de carrera del maestro en tercer grado: "level1" (nivel 1), "level2" (nivel 2), "level3" (nivel 3), "apprentice" (aprendiz), "probation" (en prueba) o "noladder" (sin nivel).

32. **experiencek**: Años de experiencia total del maestro en jardín de infancia.

33. **experience1**: Años de experiencia total del maestro en primer grado.

34. **experience2**: Años de experiencia total del maestro en segundo grado.

35. **experience3**: Años de experiencia total del maestro en tercer grado.

36. **tethnicityk**: Factor que indica la etnicidad del maestro en jardín de infancia con niveles "cauc" (Caucásico) o "afam" (Afroamericano).

37. **tethnicity1**: Factor que indica la etnicidad del maestro en primer grado con niveles "cauc" (Caucásico) o "afam" (Afroamericano).

38. **tethnicity2**: Factor que indica la etnicidad del maestro en segundo grado con niveles "cauc" (Caucásico) o "afam" (Afroamericano).

39. **tethnicity3**: Factor que indica la etnicidad del maestro en tercer grado con niveles "cauc" (Caucásico), "afam" (Afroamericano) o "asian" (Asiático).

40. **systemk**: Factor que indica el ID del sistema escolar en jardín de infancia.

41. **system1**: Factor que indica el ID del sistema escolar en primer grado.

42. **system2**: Factor que indica el ID del sistema escolar en segundo grado.

43. **system3**: Factor que indica el ID del sistema escolar en tercer grado.

44. **schoolidk**: Factor que indica el ID de la escuela en jardín de infancia.

45. **schoolid1**: Factor que indica el ID de la escuela en primer grado.

46. **schoolid2**: Factor que indica el ID de la escuela en segundo grado.

47. **schoolid3**: Factor que indica el ID de la escuela en tercer grado.

### Análisis exploratorio de datos

Observamos que hay una gran cantidad de datos faltantes en la mayor parte de las variables.

```{r aed-na, fig.cap=capFig("Porcentaje de valores faltantes en las variables del conjunto de datos.", y = "aed-na")}
na_counts <- sapply(starDf, function(x) sum(is.na(x)))
total_counts <- nrow(starDf)

na_percentage <- (na_counts / total_counts) * 100

na_percentage_df <- data.frame(
  Column = names(na_percentage),
  NA_Percentage = as.numeric(na_percentage)
)

ggplot(na_percentage_df, aes(x = Column, y = NA_Percentage)) +
  geom_bar(stat = "identity") +
  labs(x = "Característica",
       y = "Porcentaje de NA (%)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(labels = scales::percent_format(scale = 1))
```

Esto se debe a la naturaleza de los datos: por ejemplo, consideremos la primera observación.

```{r aed-na-ejemplo}
starDf[1, ]
```

En la salida encontramos que el estudiante ingresó al experimento en tercer grado en una clase regular, por lo que el tamaño de la clase se registra en star3 y las otras variables indicadoras de tipo de clase son `NA`. De la misma manera, sus puntuaciones de matemáticas y lectura para el tercer grado están disponibles; sin embargo, los valores de estas variables para otros grados no están presentes por la misma razón.

A modo de comprobación, nos aseguramos todas las entradas corresponden a estudiantes que participaron en el proyecto *STAR* al menos durante uno de los cuatro años.

```{r}
nAllStarsNA <- sum(rowSums(is.na(starDf[, c("stark", "star1", "star2", "star3")])) == 4)
cat("Número de entradas sin participaciones:", nAllStarsNA)
```

A continuación, analizamos las distribuciones de las variables descritas.

```{r aed-genero, fig.cap=capFig("Diagrama de barras del género de los estudiantes.", y = "aed-genero")}
ggplot(starDf, aes(x = gender)) +
  geom_bar() +
  labs(x = "Género", y = "Frecuencia acumulada")
```


```{r aed-etnicidad, fig.cap=capFig("Diagrama de barras de la etnicidad de los estudiantes.", y = "aed-etnicidad")}
ggplot(starDf, aes(x = ethnicity)) +
  geom_bar() +
  labs(x = "Etnicidad", y = "Frecuencia acumulada")
```


```{r aed-trim-nac, fig.cap=capFig("Diagrama de barras del trimestre de nacimiento de los estudiantes.", y = "aed-trim-nac")}
ggplot(starDf, aes(x = birth)) +
  geom_bar() +
  labs(x = "Trimestre de nacimiento", y = "Frecuencia acumulada")
```

```{r aed-grupo, fig.cap=capFig("Diagrama de barras del grupo experimental de todos los cursos.", y = "aed-grupo")}
plotCombinedFeature(starDf, "star", "Grupo experimental", isNumeric = FALSE)
```

```{r aed-lectura, fig.cap=capFig("Boxplot de la puntuación de lectura de todos los cursos.", y = "aed-lectura")}
plotCombinedFeature(starDf, "read", "Puntuación de lectura")
```


```{r aed-mate, fig.cap=capFig("Boxplot de la puntuación de matemáticas de todos los cursos.", y = "aed-mate")}
plotCombinedFeature(starDf, "math", "Puntuación de matemáticas")
```


```{r aed-almuerzo, fig.cap=capFig("Diagrama de barras de la participación en el almuerzo gratuito de todos los cursos.", y = "aed-almuerzo")}
plotCombinedFeature(starDf, "lunch", "Almuerzo", isNumeric = FALSE)
```

```{r aed-tipo-escuela, fig.cap=capFig("Diagrama de barras del tipo de escuela de todos los cursos.", y = "aed-tipo-escuela")}
plotCombinedFeature(starDf, "school", "Tipo de escuela", isNumeric = FALSE)
```

```{r aed-titulo-maestro, fig.cap=capFig("Diagrama de barras del máximo título académico del maestro de todos los cursos.", y = "aed-titulo-maestro")}
plotCombinedFeature(starDf, "degree", "Título académico", isNumeric = FALSE)
```

```{r aed-nivel-carrera, fig.cap=capFig("Diagrama de barras del nivel de carrera del maestro de todos los cursos.", y = "aed-nivel-carrera")}
plotCombinedFeature(starDf, "ladder", "Nivel de carrera", isNumeric = FALSE)
```

```{r aed-exp, fig.cap=capFig("Boxplot de la experiencia del maestro de todos los cursos.", y = "aed-exp")}
plotCombinedFeature(starDf, "experience", "Experiencia del maestro (años)")
```

```{r aed-etnicidad-maestro, fig.cap=capFig("Diagrama de barras de la etnicidad del maestro de todos los cursos.", y = "aed-etnicidad-maestro")}
plotCombinedFeature(starDf, "tethnicity", "Etnicidad del maestro", isNumeric = FALSE)
```

```{r aed-id-escuela, fig.cap=capFig("Diagrama de barras de la etnicidad del maestro de todos los cursos.", y = "aed-id-escuela")}
plotCombinedFeature(starDf, "schoolid", "Identificador de escuela", isNumeric = FALSE, removeNa = TRUE)
```


### Identificación de efecto y tratamiento

En el proyecto *STAR*, el tratamiento aplicado es la pertenencia a clases reducidas y a clases normales con ayuda, frente a clases normales sin ayuda. En este trabajo, consideramos sólo el tratamiento de clase reducida frente a clase normal.

Por otra parte, escogemos como variable de respuesta una nueva variable **nota**, definida como la suma de las puntuaciones en lectura y matemáticas, habitual en la literatura relacionada con este estudio. También definimos las nuevas variables **birth_year** y **birth_quantile**, a partir de la variable **birth**, que es una variable de tipo yearqtl, y la convertimos en una vaariable con el año de nacimiento de tipo numérico y otra con el cuatrimeste de nacimiento, de tipo facto, para así poder compararlas don otras variables numéricas y de tipo factor.

Además, realizamos el análisis del efecto del tratamiento de manera independiente para cada curso escolar.

```{r}
starDf <- starDf %>% 
  mutate(
    notak = readk + mathk,
    nota1 = read1 + math1,
    nota2 = read2 + math2,
    nota3 = read3 + math3,
    birth_year = as.numeric(format(starDf$birth, "%Y")),
    birth_quantile = as.factor(format(starDf$birth, "%q"))
  )

starDfk <- starDf %>% filter(stark != "regular+aide") %>% mutate(stark = ifelse(stark == "small", 1, 0))
starDf1 <- starDf %>% filter(star1 != "regular+aide") %>% mutate(star1 = ifelse(star1 == "small", 1, 0))
starDf2 <- starDf %>% filter(star2 != "regular+aide") %>% mutate(star2 = ifelse(star2 == "small", 1, 0))
starDf3 <- starDf %>% filter(star3 != "regular+aide") %>% mutate(star3 = ifelse(star3 == "small", 1, 0))
```

```{r}
nota <- data.frame(
  # Kindergarten
  notak <- starDf$readk + starDf$mathk,
  # 1st Grade
  nota1 <- starDf$read1 + starDf$math1,
  # 2nd Grade
  nota2 <- starDf$read2 + starDf$math2,
  # 3rd Grade
  nota3 <- starDf$read3 + starDf$math3
)

# Eliminar los registros con NA en cualquier variable 'nota'
nota <- nota[complete.cases(nota), ]
```

A continuación se calculan las correlaciones entre las variables numéricas disponibles para cada curso escolar.

```{r}
cor(starDfk[, c("notak", "experiencek", "birth_year")], use = "complete.obs")
cor(starDf1[, c("nota1", "experience1", "birth_year")], use = "complete.obs")
cor(starDf2[, c("nota2", "experience2", "birth_year")], use = "complete.obs")
cor(starDf3[, c("nota3", "experience3", "birth_year")], use = "complete.obs")
```

Como esperaríamos, no hay una correlación alta entre el año de nacimiento y la nota obtenida en ningún curso. Tampoco parece haber una correlación entre los años de experiencia de los maestros y la nota obtenida por los alumnos. Por otro lado, como es lógico, tampoco hay una correlación entre los años de experiencia de los maestro y los años de nacimiento de los alumnos.

A continuación analizamos posiblles asociaciones entre variables categóricas para cada curso mediante el estadístico V de Cramer, que está acotado entre 0 y 1, siendo 1 asociación total entre un par de variables categóricas y 0 ninguna asociación. 

```{r}
# Función para calcular V de Cramer
cramer_v <- function(x, y) {
  tbl <- table(x, y, useNA = "no")
  chi2 <- chisq.test(tbl)$statistic
  n <- sum(tbl)
  min_dim <- min(dim(tbl)) - 1
  v <- sqrt(chi2 / (n * min_dim))
  return(v)
}
```

```{r}
# Seleccionar solo las columnas categóricas
categorical_vars <- starDfk[,c("stark", "gender", "birth_quantile", "lunchk", "schoolk", "degreek", "ladderk", "tethnicityk", "systemk")]
var_names <- colnames(categorical_vars)

# Crear una matriz para almacenar los coeficientes V de Cramer
n <- length(var_names)
cramer_matrix <- matrix(NA, n, n, dimnames = list(var_names, var_names))

# Calcular V de Cramer para cada par de variables categóricas
for (i in 1:(n-1)) {
  for (j in (i+1):n) {
    cramer_matrix[i, j] <- cramer_v(categorical_vars[[i]], categorical_vars[[j]])
    cramer_matrix[j, i] <- cramer_matrix[i, j]
  }
}

# Mostrar la matriz de coeficientes V de Cramer
print(cramer_matrix)
```

```{r}
# Seleccionar solo las columnas categóricas
categorical_vars <- starDf1[,c("star1", "gender", "birth_quantile", "lunch1", "school1", "degree1", "ladder1", "tethnicity1", "system1")]
var_names <- colnames(categorical_vars)

# Crear una matriz para almacenar los coeficientes V de Cramer
n <- length(var_names)
cramer_matrix <- matrix(NA, n, n, dimnames = list(var_names, var_names))

# Calcular V de Cramer para cada par de variables categóricas
for (i in 1:(n-1)) {
  for (j in (i+1):n) {
    cramer_matrix[i, j] <- cramer_v(categorical_vars[[i]], categorical_vars[[j]])
    cramer_matrix[j, i] <- cramer_matrix[i, j]
  }
}

# Mostrar la matriz de coeficientes V de Cramer
print(cramer_matrix)
```

```{r}
# Seleccionar solo las columnas categóricas
categorical_vars <- starDf2[,c("star2", "gender", "birth_quantile", "lunch2", "school2", "degree2", "ladder2", "tethnicity2", "system2")]
var_names <- colnames(categorical_vars)

# Crear una matriz para almacenar los coeficientes V de Cramer
n <- length(var_names)
cramer_matrix <- matrix(NA, n, n, dimnames = list(var_names, var_names))

# Calcular V de Cramer para cada par de variables categóricas
for (i in 1:(n-1)) {
  for (j in (i+1):n) {
    cramer_matrix[i, j] <- cramer_v(categorical_vars[[i]], categorical_vars[[j]])
    cramer_matrix[j, i] <- cramer_matrix[i, j]
  }
}

# Mostrar la matriz de coeficientes V de Cramer
print(cramer_matrix)
```

```{r}
# Seleccionar solo las columnas categóricas
categorical_vars <- starDf3[,c("star3", "gender", "birth_quantile", "lunch3", "school3", "degree3", "ladder3", "tethnicity3", "system3")]
var_names <- colnames(categorical_vars)

# Crear una matriz para almacenar los coeficientes V de Cramer
n <- length(var_names)
cramer_matrix <- matrix(NA, n, n, dimnames = list(var_names, var_names))

# Calcular V de Cramer para cada par de variables categóricas
for (i in 1:(n-1)) {
  for (j in (i+1):n) {
    cramer_matrix[i, j] <- cramer_v(categorical_vars[[i]], categorical_vars[[j]])
    cramer_matrix[j, i] <- cramer_matrix[i, j]
  }
}

# Mostrar la matriz de coeficientes V de Cramer
print(cramer_matrix)
```


No se observa ninguna asociación fuerte entre el tratamiento y el resto de variables categóricas, lo cuál está en concordancia con la asignación aleatoria del tratamiento. Donde sí observamos una mayor asociación es entre el tipo de escuela **school** y otras variables como **lunch**, lo cuál tiene sentido porque en el estudio se menciona que, la categoría de **schools** "inner-city" se asignó para las escuelas donde los alumnos recibían descuentos en la comida o comidas gratis. También observamos una cierta asociación con **tethnicity**, lo cuál llama más la atención teniendo en cuenta que en teoría la asignación de los profesores a las escuelas también era aleatoria. Esto nos hace sospechar de que quizá pudo haberse saltado el procedimiento en algún caso. La alta asociación entre **school** y **system** se explica porque debido a que escuelas del mismo tipo pueden pertenecer al mismo sistema escolar.

También observamos más asociaciones de la variable **system** con la variable con otras como **lunch**, en cuyo caso el orígen de la asociación sería el mismo que para **svhool**, pero también vemos una asociación con el grado de estudios de los profesores (**degree**) y su nivel de escala profesioneal (**ladder**), así como su etnia (**teychnicity**), lo que de nuevo mos hace sospechar de la asignación aleatoria de los profesores.


Con la finalidad de diseñar un modelo causal, a continuación vamos a comprobar qué variables son más relevantes en un modelo de regresión lineal que prediga la respuesta al tratamiento, ya que las variables más relevantes pueden ser candidatas a variables confusoras del modelo causal, o explicar parte de la variabilidad de la respuesta.

Para determinar si estas variables son significativas en la predicción, realizaremos un test t-Student sobre cada uno de los coeficientes de la regresión. Puesto que vamos a realizar un análisis independiente para cada curso escolar, planteamos cuatro modelos distintos, uno para cada curso, donde tanto las variables como la respuesta seleccionadas se corresponden a su curso correspondiente.

```{r}
lmk <- lm(notak ~ stark + gender + ethnicity + birth + lunchk + schoolk + degreek + ladderk + experiencek + tethnicityk + systemk + schoolidk, data=starDfk, na.action=na.exclude)
summary(lmk)
```

```{r}
lm1 <- lm(nota1 ~ star1 + gender + ethnicity + birth + lunch1 + school1 + degree1 + ladder1 + experience1 + tethnicity1 + system1 + schoolid1, data=starDf1, na.action=na.exclude)
summary(lm1)
```

```{r}
lm2 <- lm(nota2 ~ star2 + gender + ethnicity + birth + lunch2 + school2 + degree2 + ladder2 + experience2 + tethnicity2 + system2 + schoolid2, data=starDf2, na.action=na.exclude)
summary(lm2)
```

```{r}
lm3 <- lm(nota3 ~ star3 + gender + ethnicity + birth + lunch3 + school3 + degree3 + ladder3 + experience3 + tethnicity3 + system3 + schoolid3, data=starDf3, na.action=na.exclude)
summary(lm3)
```

Algunos factores importantes que influencian la respuesta en todos los cursos son el género de los alumnos, el hecho de que estos fueran de etnia afroamericana o que dispusieran de comidas gratis y el tipo de escuela (especialmente si es urbana o suburbana). También parece haber influencia de determinadas escuelas (**schoolid**) en la respuesta, lo cuál puede ser indicativo de la influencia de variables no observadas.

Por tanto, tras este análisis y tras contrastar con otros análisis externos como el realizado en https://www.econometrics-with-r.org/13.3-experimental-estimates-of-the-effect-of-class-size-reductions.html, tomamos como posibles variables de confusión:

- **gender**
- **ethnicity**
- **lunch**
- **school**

```{r}
library(ggdag)

dag <- dagify(star~gender+ethnnicity+lunch+school,
              nota~star+gender+ethnnicity+lunch+school,
              exposure = "star", outcome = "nota")

ggdag(dag)
```


## Estimación naive del efecto del tratamiento

Para obtener una primera estimación del efecto medio del tratamiento (AET) para cada curso podemos emplear el estimador diferencia en medias (DIM), definido como el valor promedio de la respuesta de los tratados menos el valor promedio de la respuesta para los no tratados. En ausencia de independencia, independencia condicional o asigación aleatoria del tratamiento, este es un estimador sesgado y es distinto al efecto medio del tratamiento.

Según la documentación del estudio, tanto la asignación de alumnos como de profesores fue totalmente aleatoria, por lo que podemos tomar el DIM como una primera estimación válida del AET con la que comparar el resto de estimaciones que realizaremos más adelante, considerando ya variables de confusión.


```{r}
dimk <- mean(starDfk[starDfk$stark==1, "notak"], na.rm = T) - mean(starDfk[starDfk$stark==0, "notak"], na.rm=T)
dim1 <- mean(starDf1[starDf1$star1==1, "nota1"], na.rm = T) - mean(starDf1[starDf1$star1==0, "nota1"], na.rm=T)
dim2 <- mean(starDf2[starDf2$star2==1, "nota2"], na.rm = T) - mean(starDf2[starDf2$star2==0, "nota2"], na.rm=T)
dim3 <- mean(starDf3[starDf3$star3==1, "nota3"], na.rm = T) - mean(starDf3[starDf3$star3==0, "nota3"], na.rm=T)

data.frame(
  Curso = c("k", "1", "2", "3"),
  DIM = c(dimk, dim1, dim2, dim3)
)
```

De este primer resultado cabe destacar que el curso para el que el efecto del tratamiento es menor es el de guardería, seguido por tercero, luego segundo y a bastante diferenecia primero. Esta diferencia, no obstante, podría deberse a una mera casualidad como que los alumnos de la clase normal tuvieran unas notas muy pobres durante un año. En cualquier caso, observamos una estimación del efecto medio positiva para alumnos de todos los cursos.

